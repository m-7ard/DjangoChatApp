{% extends "rooms/app.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'rooms/channel.css' %}">
{% endblock %}

{% block main %}
<div class="app-section--main__header">
	<div class="app-section--main__title">
		{{ channel.name }}
	</div>
</div>
<div class="app-section--main__subheader">
	{{ channel.description }}
</div>
<div class="wrapper--remaining-space">
	<ul class="app-section--main__channel">
		<div class="app-section--main__react">
			<div class="app-section--main__react-header">Add Reaction</div>
			<div class="app-section--main__react-body">
				<div class="app-section--main__react-servers">
					
				</div>
				<div class="wrapper--remaining-space">
					<div class="app-section--main__react-emotes">
						{% for reaction in room.reactions.all %}
						<div class="app-section--main__react-emote" pk="{{ reaction.pk }}">
							<img src="{{ MEDIA_URL }}{{ reaction.image.url }}" alt="">
						</div>
						{% endfor %}
					</div>
				</div>		
			</div>
		</div>
		{% for backlog in backlogs %}
		{% if backlog.instance == 'message' %}
		<li class="app-section--main__message" pk="{{ backlog.pk }}">
			<div class="app-section--main__message-timestamp">{{ backlog.display_date }}</div>
			<div class="app-section--main__message-user">{{ backlog.user }}</div>
			<div class="app-section--main__message-blank"></div>
			<div class="app-section--main__message-body">
				<span>{{ backlog.content }}</span>
				<div class="app-section--main__message-actions">
					<span action="react">
						<i class="material-symbols-outlined">add_reaction</i>
					</span>
					<span action="delete">
						<i class="material-symbols-outlined">delete</i>
					</span>
					<span action="menu">
						<i class="material-symbols-outlined">menu</i>
					</span>						
				</div>
			</div>
			<div class="app-section--main__message-blank"></div>
			<div class="app-section--main__message-reactions">
				{% for message_reaction in backlog.reactions.all %}
				{% if user in message_reaction.users.all %}
				<div class="app-section--main__message-reaction active" pk="{{ message_reaction.reaction.pk }}">
				{% else %}
				<div class="app-section--main__message-reaction inactive" pk="{{ message_reaction.reaction.pk }}">
				{% endif %}
					<img src="{{ MEDIA_URL }}{{ message_reaction.reaction.image.url }}" alt="">
					<span class="count">{{ message_reaction.users.count }}</span>
				</div>
				{% endfor %}
			</div>
		</li>
		{% elif backlog.instance == 'log' %}
		<li class="app-section--main__log">
			<div class="app-section--main__message-header">
				<span class="app-section--main__log-user">{{ backlog.trigger_user }} </span>
				<span class="app-section--main__log-action">{{ backlog.action_display_name }}</span>
				{% if backlog.target_user %}
				<span class="app-section--main__log-user">{{ backlog.target_user }} </span>
				{% endif %}
				<span class="app-section--main__log-timestamp">{{ backlog.display_date }}</span>
			</div>
		</li>
		{% endif %}
		{% endfor %}
	</ul>
</div>
<form class="app-section--main__chatbar">
	<div class="wrapper--remaining-space">
		<textarea class="app-section--main__chatbar-input"></textarea>
	</div>
	<button class="app-section--main__chatbar-submit" type="submit">
		<i class="material-symbols-outlined">
			send
		</i>
	</button>
</form>

{% endblock %}

{% block secondary-sidebar %}
<div class="app-section--sidebar__element">
	<div class="app-section--sidebar__header">
		Members
	</div>
	<div class="wrapper--remaining-space">
		<ul class="app-section--sidebar__content app-section--sidebar__content--has-padding">
			<li class="app-section--sidebar__label">Online</li>
			{% for member in room.members.all %}
			<li class="app-section--sidebar__friend">
				<div class="app-section--sidebar__avatar">
					<div style="width: 2rem; height: 2rem; background-color: brown;"></div>
				</div>
				<ul class="app-section--sidebar__friend-info">
					<div class="wrapper--remaining-space">
						<li class="app-section--sidebar__username app-section--sidebar__username--online">
							{{ member }}
						</li>
					</div>
					<li class="app-section--sidebar__status app-section--sidebar__status--online">
						Online
					</li>
				</ul>
			</li>
			{% endfor %}
		</ul>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
{{ room.id|json_script:"room-id" }}
{{ channel.id|json_script:"channel-id" }}
{{ request.user.id|json_script:"user-id" }}
<script>
window.addEventListener("load", function() {
	// DOM elements
	const messageForm = document.querySelector('.app-section--main__chatbar')
	const messageInput = document.querySelector('.app-section--main__chatbar-input');
	const messageContainer = document.querySelector('.app-section--main__channel');
	messageContainer.scrollTop = messageContainer.scrollHeight;
	const joinButton = document.querySelector('.app-section--sidebar__button--join');
	const leaveButton = document.querySelector('.app-section--sidebar__button--leave');
	const reactionEmotes = document.querySelectorAll('.app-section--main__react-emote');

	// JSON elements
	const channelID = JSON.parse(document.getElementById('channel-id').textContent);
	const roomID = JSON.parse(document.getElementById('room-id').textContent);
	const userID = JSON.parse(document.getElementById('user-id').textContent);

	// Websocket related arguments
	let tabPk;

	// actions that receive data from the WebSocket
	const chatSocketReceiveHandlers = {
		'message': 
			function(data) {
				let message = document.createElement('li');
				message.classList.add('app-section--main__message');
				message.setAttribute('pk', `${data.pk}`)
				message.innerHTML += (
				`
				<div class="app-section--main__message-timestamp">${data.date}</div>
				<div class="app-section--main__message-user">${data.username}</div>
				<div class="app-section--main__message-blank"></div>
				<div class="app-section--main__message-body">
					${data.content}
					<div class="app-section--main__message-actions">
						<span action="react"><i class="gg-awards"></i></span>
						<span action="delete"><i class="gg-trash"></i></span>
						<span action="menu"><i class="gg-format-justify"></i></span>
					</div>
				</div>
				`
				);
				messageContainer.appendChild(message);
				messageContainer.scrollTop = messageContainer.scrollHeight;
			},
		'delete': 
			function(data) {
				let pk = data.pk;
				let message = document.querySelector(`.app-section--main__message[pk="${pk}"]`);
				message.remove();
			},
		'log':
			function(data) {
				let triggerUser = data.trigger_user;
				let targetUser = data.target_user;
				let action = data.action_display_name;
				let date = data.date;

				let log = document.createElement('li');
				log.classList.add('app-section--main__log');
				if (targetUser) {
					log.innerHTML += (
					`
					<div class="app-section--main__message-header">
						<span class="app-section--main__log-user">${triggerUser}</span>
						<span class="app-section--main__log-action">${action}</span>
						<span class="app-section--main__log-user">${targetUser}</span>
						<span class="app-section--main__log-timestamp">${date}</span>
					</div>
					`
					);
				}
				else {
					log.innerHTML += (
					`
					<div class="app-section--main__message-header">
						<span class="app-section--main__log-user">${triggerUser}</span>
						<span class="app-section--main__log-action">${action}</span>
						<span class="app-section--main__log-timestamp">${date}</span>
					</div>
					`
					);
				};
				
				messageContainer.appendChild(log);
				messageContainer.scrollTop = messageContainer.scrollHeight;
			},
		"react":
			function(data) {
				let reactionPk = data.reaction_pk;
				let messagePk = data.message_pk;

				let loggedInUserPk = parseInt("{{ user.pk }}");
				let websocketUserPk = data.user_pk;

				// message
				let message = messageContainer.querySelector(`.app-section--main__message[pk="${messagePk}"]`)
				// specific message reaction or null
				let reaction = message.querySelector(`.app-section--main__message-reaction[pk="${reactionPk}"]`);
				// container with all reactions or null
				let reactions = message.querySelector('.app-section--main__message-reactions');

				let imageURL = data.image_URL;
				let modifier = data.modifier;

				if (modifier == 'create') {
					let newReaction = document.createElement('div');
					newReaction.classList.add('app-section--main__message-reaction');
					loggedInUserPk === websocketUserPk ? newReaction.classList.add('active') : newReaction.classList.add('inactive');
					newReaction.setAttribute('pk', reactionPk);
					newReaction.innerHTML += (
					`
					<img src="${imageURL}">
					<span class="count">1</span>
					`
					);
					reactions.appendChild(newReaction);
				}
				else if (modifier == 'delete') {
					reaction.remove()
				}
				else if (modifier == 'add') {
					let count = reaction.querySelector('.count');
					toggleReactionClass(reaction);
					count.innerHTML = parseInt(count.innerHTML) + 1;
				}
				else if (modifier == 'remove') {
					let count = reaction.querySelector('.count');
					toggleReactionClass(reaction);
					count.innerHTML = parseInt(count.innerHTML) - 1;
				};

				function toggleReactionClass(reaction) {
					if (loggedInUserPk === websocketUserPk) {
						reaction.classList.toggle('active');
						reaction.classList.toggle('inactive');
					};
				};
			},
		'tab':
			function(data) {
				tabPk = data.pk;
			},
	};

	// actions that send data to the WebSocket
	const chatSocketSendHandlers = {
		"message": 
			function(event) {
				event.preventDefault();
				if ((event.key === "Enter" && !event.shiftKey) || event.type == "submit") { 
						let content = messageInput.value;
						chatSocket.send(JSON.stringify({
							'action': 'message',
							'content': content,
							'user': userID,
							'channel': channelID,
						}));
						messageInput.value = '';
				};
			},
		"join": 
			function(event) {
				chatSocket.send(JSON.stringify({
					'action': 'join'
				}));
			},
		"leave":
			function(event) {
				chatSocket.send(JSON.stringify({
					'action': 'leave'
				}));
			},
		"delete":
			function(event) {
				let message = event.target.closest(`.app-section--main__message`);
				let pk = message.getAttribute('pk');
				chatSocket.send(JSON.stringify({
					'action': 'delete',
					'pk': pk
				}));
			},
		"react":
			function(event) {
				let reaction;
				let message;
				if (event.target.closest('.app-section--main__react')) {
					reaction = event.target.closest('.app-section--main__react-emote');
					message = (
						messageContainer.querySelector('.has-open-action')
						.closest('.app-section--main__message')
					);
				}
				else {
					reaction = event.target.closest('.app-section--main__message-reaction');
					message = event.target.closest('.app-section--main__message');
				};
				
				let messagePk = message.getAttribute('pk');
				let reactionPk = reaction.getAttribute('pk');
				console.log(reactionPk)
				chatSocket.send(JSON.stringify({
					'action': 'react',
					'reaction_pk': reactionPk,
					'message_pk': messagePk,
				}));
			},
	};

	// actions that relate to the messages
	const messageActionHandlers = {
		"delete":
			chatSocketSendHandlers["delete"],
		'menu': 
			function(event) {
				console.log('balls')
			},
		'react':
			function(event) {
				event.stopPropagation();
				let message = event.target.closest('.app-section--main__message');
				let actionsContainer = message.querySelector('.app-section--main__message-actions');
				let reactionsTooltip = document.querySelector('.app-section--main__react');

				if (reactionsTooltip.style.display == 'flex') {
					reactionsTooltip.style.display = 'none';
					window.removeEventListener('click', closeTooltipAndResetActions);
				}
				else {
					// keep the action field displayed while the tooltip is open
					actionsContainer.classList.add('has-open-action');
					Popper.createPopper(actionsContainer, reactionsTooltip, {
						placement: 'bottom-end',
						modifiers: [
								{
								name: 'offset',
								options: {
									offset: [0, 5],
								},
							},
						],
					});
					reactionsTooltip.style.display = 'flex';
					window.addEventListener('click', closeTooltipAndResetActions);
				};

				function closeTooltipAndResetActions(event) {
					if (!event.target.closest('.app-section--main__react')) {
						reactionsTooltip.style.display = 'none';
						actionsContainer.classList.remove('has-open-action');
						window.removeEventListener('click', closeTooltipAndResetActions);
					};
				};
			},
	};

	const chatSocket = new WebSocket(
		'ws://'
		+ window.location.host
		+ '/ws/chat/'
		+ roomID
		+ '/'
		+ channelID
	);

	chatSocket.onmessage = function(event) {
		let data = JSON.parse(event.data);
		let action = data.action;
		let handler = chatSocketReceiveHandlers[action];
		handler(data);
	};

	chatSocket.onclose = function(event) {
		console.log('onclose');
	};
	

	
	messageContainer.addEventListener('click', messageActionDelegator);
	messageContainer.addEventListener('click', messageReactionListener)
	messageForm.addEventListener("submit", chatSocketSendHandlers["message"]);
	messageInput.addEventListener("keyup", chatSocketSendHandlers["message"]);
	joinButton && joinButton.addEventListener('click', chatSocketSendHandlers["join"]);
	leaveButton && leaveButton.addEventListener('click', chatSocketSendHandlers["leave"]);
	reactionEmotes && reactionEmotes.forEach((element) => element.addEventListener("click", chatSocketSendHandlers["react"]))


	function messageActionDelegator(event) {
		let actionNode = event.target.closest('[action]');
		if (actionNode) {
			let action = actionNode.getAttribute('action');
			let handler = messageActionHandlers[action];
			handler(event);
		};
	};

	function messageReactionListener(event) {
		if (event.target.closest('.app-section--main__message-reaction')) {
			let handler = chatSocketSendHandlers["react"];
			handler(event);
		}
	};
});
</script>
{% endblock %}