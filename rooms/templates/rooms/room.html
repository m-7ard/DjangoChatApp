{% extends "rooms/app.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'rooms/room.css' %}">
{% endblock %}

{% block app__main %}
<div class="container container--fill">
	<div class="wrapper--remaining-space">
		<div class="container__content">
			
		</div>
	</div>
</div>

{% endblock %}

{% block app__sidebar--primary %}
	{% include "./elements/app__sidebar--primary.html" %}
{% endblock %}

{% block scripts %}
{{ block.super }}
{{ room.id|json_script:"room-id" }}
{{ request.user.id|json_script:"user-id" }}
<script>
window.addEventListener("load", function() {
	// DOM elements
	const joinButton = document.querySelector('.app-section--sidebar__button--join');
	const leaveButton = document.querySelector('.app-section--sidebar__button--leave');

	// JSON elements
	const roomID = JSON.parse(document.getElementById('room-id').textContent);
	const userID = JSON.parse(document.getElementById('user-id').textContent);

	const ChatSocket = new WebSocket(
		'ws://'
		+ window.location.host
		+ '/ws/chat/'
		+ roomID
		+ '/'
	);

	// ChatSocket.onmessage

	ChatSocket.onclose = function(event) {
		console.log('onclose');
	};

	const ChatSocketHandlers = {
		"message": 
			function(event) {
				if (event.key === "Enter" && !event.shiftKey) {
					event.preventDefault();
					let content = messageInput.value;
					ChatSocket.send(JSON.stringify({
						'action': 'message',
						'content': content,
						'user': userID,
						'channel': channelID,
					}));
					messageInput.value = '';
				}
			},
		"join": 
			function(event) {
				ChatSocket.send(JSON.stringify({
					'action': 'join'
				}));
			},
		"leave":
			function() {
				ChatSocket.send(JSON.stringify({
					'action': 'leave'
				}));
			},
	};

	joinButton && joinButton.addEventListener('click', ChatSocketHandlers["join"]);
	leaveButton && leaveButton.addEventListener('click', ChatSocketHandlers["leave"]);
});
</script>
{% endblock %}