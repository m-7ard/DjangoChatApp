{% extends "core/header.html" %}
{% load static %}
{% load custom_tags %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{% static 'rooms/app.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'rooms/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="app">
	<!--

		PRIMARY SIDEBAR

	-->	
	<div class="app-section--sidebar primary">
		<div class="app-section--sidebar__element">
			<div class="app-section--sidebar__header">
				Friends
			</div>
			<div class="wrapper--remaining-space">
				<ul class="app-section--sidebar__content app-section--sidebar__content--has-padding">
					<li class="app-section--sidebar__label">Online</li>
					<li class="app-section--sidebar__friend">
						<div class="app-section--sidebar__avatar">
							<div style="width: 2rem; height: 2rem; background-color: brown;"></div>
						</div>
						<ul class="app-section--sidebar__friend-info">
							<div class="wrapper--remaining-space">
								<li class="app-section--sidebar__username app-section--sidebar__username--online">
									User name User name User name
								</li>
							</div>
							<li class="app-section--sidebar__status app-section--sidebar__status--online">
								Online
							</li>
						</ul>
					</li>
					<li class="app-section--sidebar__friend">
						<div class="app-section--sidebar__avatar">
							<div style="width: 2rem; height: 2rem; background-color: brown;"></div>
						</div>
						<ul class="app-section--sidebar__friend-info">
							<div class="wrapper--remaining-space">
								<li class="app-section--sidebar__username app-section--sidebar__username--online">
									User name User name User name
								</li>
							</div>
							<li class="app-section--sidebar__status app-section--sidebar__status--online">
								Online
							</li>
						</ul>
					</li>
					<li class="app-section--sidebar__friend">
						<div class="app-section--sidebar__avatar">
							<div style="width: 2rem; height: 2rem; background-color: brown;"></div>
						</div>
						<ul class="app-section--sidebar__friend-info">
							<div class="wrapper--remaining-space">
								<li class="app-section--sidebar__username app-section--sidebar__username--online">
									User name User name User name
								</li>
							</div>
							<li class="app-section--sidebar__status app-section--sidebar__status--online">
								Online
							</li>
						</ul>
					</li>
					<li class="app-section--sidebar__label">Offline</li>
					<li class="app-section--sidebar__friend">
						<div class="app-section--sidebar__avatar">
							<div style="width: 2rem; height: 2rem; background-color: brown;"></div>
						</div>
						<ul class="app-section--sidebar__friend-info">
							<div class="wrapper--remaining-space">
								<li class="app-section--sidebar__username app-section--sidebar__username--offline">
									User name User name User name
								</li>
							</div>
							<li class="app-section--sidebar__status app-section--sidebar__status--offline">
								Online
							</li>
						</ul>
					</li>
					<li class="app-section--sidebar__friend">
						<div class="app-section--sidebar__avatar">
							<div style="width: 2rem; height: 2rem; background-color: brown;"></div>
						</div>
						<ul class="app-section--sidebar__friend-info">
							<div class="wrapper--remaining-space">
								<li class="app-section--sidebar__username app-section--sidebar__username--offline">
									User name User name User name
								</li>
							</div>
							<li class="app-section--sidebar__status app-section--sidebar__status--offline">
								Online
							</li>
						</ul>
					</li>
					<li class="app-section--sidebar__friend">
						<div class="app-section--sidebar__avatar">
							<div style="width: 2rem; height: 2rem; background-color: brown;"></div>
						</div>
						<ul class="app-section--sidebar__friend-info">
							<div class="wrapper--remaining-space">
								<li class="app-section--sidebar__username app-section--sidebar__username--offline">
									User name User name User name
								</li>
							</div>
							<li class="app-section--sidebar__status app-section--sidebar__status--offline">
								Online
							</li>
						</ul>
					</li>
					<li class="app-section--sidebar__friend">
						<div class="app-section--sidebar__avatar">
							<div style="width: 2rem; height: 2rem; background-color: brown;"></div>
						</div>
						<ul class="app-section--sidebar__friend-info">
							<div class="wrapper--remaining-space">
								<li class="app-section--sidebar__username app-section--sidebar__username--offline">
									User name User name User name
								</li>
							</div>
							<li class="app-section--sidebar__status app-section--sidebar__status--offline">
								Online
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
		<div class="app-section--sidebar__element app-section--sidebar__element--events">
			<div class="app-section--sidebar__header">
				Events
			</div>
			<div class="wrapper--remaining-space">
				<div class="app-section--sidebar__content app-section--sidebar__content--has-padding">
					
				</div>
			</div>
		</div>
		<div class="app-section--sidebar__element app-section--sidebar__element--roomlist">
			<div class="app-section--sidebar__header">
				Chatrooms
			</div>
			<div class="wrapper--remaining-space">
				<ul class="app-section--sidebar__content app-section--sidebar__content--no-padding">
					{% for room in room_list %}
						<a href="{% url 'room' room.pk %}">
							<li class="app-section--sidebar__listroom">
								<div class="app-section--sidebar__listroom-avatar">
									<div style="width: 3rem; height: 3rem; background-color: brown;"></div>
								</div>
								<div class="app-section--sidebar__listroom-info">
									<div class="wrapper--remaining-space">
										<div class="app-section--sidebar__listroom-name">
											{{ room }}
										</div>
									</div>
								</div>
							</li>
						</a>
					{% endfor %}
				</ul>
			</div>
		</div>
		<div class="app-section--sidebar__user">
			<div class="app-section--sidebar__big-avatar">
				<div style="width: 3rem; height: 3rem; background-color: brown;"></div>
			</div>
			<ul class="app-section--sidebar__friend-info">
				<div class="wrapper--remaining-space">
					<li class="app-section--sidebar__username app-section--sidebar__username--online">
						User name User name User name
					</li>
				</div>
				<li class="app-section--sidebar__status app-section--sidebar__status--online">
					Online
				</li>
			</ul>
		</div>
	</div>
	<!--

		MAIN

	-->	
	<div class="app-section--main">
		<div class="app-section--main">
			<div class="app-section--main__header">
				<div class="app-section--main__title">
					Dashboard
				</div>
			</div>
			<div class="app-section--main__subheader">
				News, Announcements, Activity...
			</div>
			<div class="wrapper--remaining-space">
				<div class="app-section--main__dashboard">
					
				</div>
			</div>
		</div>
	</div>
	<!--

		SECONDARY SIDEBAR

	-->	
	<div class="app-section--sidebar secondary">
		<div class="app-section--sidebar__element app-section--sidebar__element--friendlist">
			<div class="app-section--sidebar__header">
				News & Updates
			</div>
			<div class="wrapper--remaining-space">
				<ul class="app-section--sidebar__content app-section--sidebar__content--friendlist">
					{% for news in site_news %}
					<li class="app-section--sidebar__news">
						<div class="app-section--sidebar__news-date">
							{{ news.day_month_year }}
						</div>
						<div class="app-section--sidebar__news-title">
							{{ news.title }}
						</div>
					</li>
					{% endfor %}
				</ul>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ channel.id|json_script:"channel-id" }}
{{ request.user.username|json_script:"username" }}
<script>
window.addEventListener("load", function() {
	const messageSubmitButton = document.querySelector('.app-section--main__chatbar-submit');
	const messageInput = document.querySelector('.app-section--main__chatbar-input');
	const messageContainer = document.querySelector('.app-section--main__channel');
	messageContainer.scrollTop = messageContainer.scrollHeight;


	const channelID = JSON.parse(document.getElementById('channel-id').textContent);
	const userName = JSON.parse(document.getElementById('username').textContent);

	const ChatSocket = new WebSocket(
		'ws://'
		+ window.location.host
		+ '/ws/chat/'
		+ channelID
		+ '/'
	);

	ChatSocket.onmessage = function(event) {
		const data = JSON.parse(event.data);
		console.log(event.data)
		if (data['pattern'] == 'joined_channel') {
			messageContainer.innerHTML += (
			`
			<li class="app-section--main__log">
				<div class="app-section--main__message-header">
					<span class="app-section--main__log-user">${data.username}</span>
					<span class="app-section--main__log-action">Joined</span>
					<span class="app-section--main__log-timestamp">${data.date}</span>
				</div>
			</li>
			`
			);
			messageContainer.scrollTop = messageContainer.scrollHeight;
		}
		else if (data['pattern'] == 'joined_channel') {
			messageContainer.innerHTML += (
			`
			<li class="app-section--main__log">
				<div class="app-section--main__message-header">
					<span class="app-section--main__log-user">${data.username}</span>
					<span class="app-section--main__log-action">Left</span>
					<span class="app-section--main__log-timestamp">${data.date}</span>
				</div>
			</li>
			`
			);
			messageContainer.scrollTop = messageContainer.scrollHeight;
		}
		else if (data['pattern'] == 'sent_message') {
			messageContainer.innerHTML += (
			`
			<li class="app-section--main__message">
				<div class="app-section--main__message-header">
					<span class="app-section--main__message-user">${data.username}</span>
					<span class="app-section--main__message-timestamp">${data.date}</span>
				</div>
				<div class="app-section--main__message-body">
					${data.content}
				</div>
			</li>
			`
			);
			messageContainer.scrollTop = messageContainer.scrollHeight;
		}
		
		
	};

	ChatSocket.onclose = function(event) {
		console.log('onclose');
	};

	function submitMessage() {
		const content = messageInput.value;
		ChatSocket.send(JSON.stringify({
			'action': 'message',
			'content': content,
			'username': userName,
			'channel': channelID,
		}));
		messageInput.value = '';
	}

	messageInput.addEventListener("keyup", function(event) {
		if (event.key === "Enter" && !event.shiftKey) {
			event.preventDefault();
			submitMessage();
		}
	});
	messageSubmitButton.addEventListener("click", function(event) {
		event.preventDefault();
		submitMessage();
	});

	/*--------------------
	Join
	--------------------*/
	let joinButton = document.querySelector('.app-section--sidebar__button--join')
	joinButton && joinButton.addEventListener('click', function() {
		ChatSocket.send(JSON.stringify({
			'action': 'join'
		}));
	});
	
	/*--------------------
	Leave
	--------------------*/
	let leaveButton = document.querySelector('.app-section--sidebar__button--leave')
	leaveButton && leaveButton.addEventListener('click', function() {
		ChatSocket.send(JSON.stringify({
			'action': 'leave'
		}));
	});
});
</script>
{% endblock %}